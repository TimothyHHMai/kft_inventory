<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script src="https://kit.fontawesome.com/3ef1b1eefa.js" crossorigin="anonymous"></script>
  <title>KFT Database</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
    }

    header {
      background-color: lightcoral;
      color: white;
      padding: 15px;
      text-align: center;
    }

    section {
      margin-bottom: 40px;
    }

    .item-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 4px 12px;
      align-items: center;
    }

    .item-grid label {
      font-weight: bold;
    }

    .item-grid span.value {
      word-break: break-word;
    }


    h2 {
      border-bottom: 2px solid #ccc;
      padding-bottom: 5px;
    }

    h3 {
      padding-bottom: 0px;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    ul.sort {
      padding-bottom: 3px;
    }

    li {
      background: #f4f4f4;
      margin: 5px 0;
      padding: 10px;
      border-radius: 5px;
    }

    li.editing {
      background-color: rgb(136, 251, 251); 
      border: 2px solid maroon;
    }

    span.actions {
      display: flex;
      gap: 10px;
      justify-content: end; 
    }

  </style>
</head>
<body>
  <header>
    <h1>KFT Database</h1>
  </header>

  <section>
    <h2>Ingredients</h2>
    
    <h3>
      Sort
    </h3>
    <ul class="sort">
      <select id="ingredient_sortBy" onchange="ingredient_change_sort()">
        <option value="expiration_date">Expiration Date</option>
        <option value="current_individual_stock">Current Individual Stock</option>
        <option value="current_box_stock">Current Box Stock</option>
        <option value="total">Current Total Stock</option> /* wip */
      </select>

      <select id="ingredient_order" onchange="ingredient_change_order()">
        <option value="asc">
          Ascending <i class="fa-solid fa-arrow-up"></i>
        </option>
        <option value="desc">
          Descending <i class="fa-solid fa-arrow-down"></i>
        </option>
      </select>
    </ul>
    
    <h3>Edit</h3>

    <form id="ingredient-form">
      <input type="hidden" id="ingredientID">
      <input type="text" id="ingredient_name" placeholder="Name" required>
      <select id="type">
        <option value="Syrup">Syrup</option>
        <option value="Powder">Powder</option>
        <option value="Topping">Topping</option>
        <option value="Tea">Tea</option>
      </select>
      <input type="number" id="quantity_box" placeholder="Quantity per Box" required>
      <input type="number" id="current_box_stock" placeholder="Box Stock" required>
      <input type="number" id="current_individual_stock" placeholder="Individual Stock" required>
      <input type="date" id="expiration_date" required>
      <button type="submit">Save Ingredient</button>
    </form>

    <ul id="ingredient-list"></ul>
  </section>

  <script>
    var ingredient_order = "asc";
    var ingredient_sortBy = "expiration_date";

    async function ingredient_change_sort() {
      const select = document.getElementById('ingredient_sortBy');
      const value = select.value;
      ingredient_sortBy = value;

      fetchIngredients();
    }
    async function ingredient_change_order() {
      const select = document.getElementById('ingredient_order');
      const value = select.value;
      ingredient_order = value;

      fetchIngredients();
    }
  </script>

  <script>
    async function fetchIngredients() {
      let url = '/api/ingredients/?sortBy=' + ingredient_sortBy 
        + "&sortOrder=" + ingredient_order;
      
      const response = await fetch(url);
      const data = await response.json();
      const list = document.getElementById('ingredient-list');
      list.innerHTML = '';

      if (data.ingredients.length === 0) {
        list.innerHTML = '<li>No ingredients found.</li>';
        return;
      }

      data.ingredients.forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="item-grid">
            <label>Name:</label> <span class="value">${item.ingredient_name}</span>
            <label>Type:</label> <span class="value">${item.type}</span>
            <label>Boxes:</label> <span class="value">${item.current_box_stock}</span>
            <label>Individual:</label> <span class="value">${item.current_individual_stock}</span>
            <label>Expiration:</label> <span class="value">${item.expiration_date}</span>
          </div>
          <span class="actions">
            <button onclick="editIngredient(${item.ingredientID})">Edit</button>
            <button onclick="deleteIngredient(${item.ingredientID})">Delete</button>
          </span>
        `;
        list.appendChild(li);
      });
    }

    document.getElementById('ingredient-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const id = document.getElementById('ingredientID').value;
      const payload = {
        ingredient_name: document.getElementById('ingredient_name').value,
        type: document.getElementById('type').value,
        quantity_box: parseInt(document.getElementById('quantity_box').value),
        current_box_stock: parseInt(document.getElementById('current_box_stock').value),
        current_individual_stock: parseInt(document.getElementById('current_individual_stock').value),
        expiration_date: document.getElementById('expiration_date').value
      };

      const url = id ? `/api/ingredients/${id}/` : `/api/ingredients/`;
      const method = id ? 'PUT' : 'POST';

      await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      this.reset();
      fetchIngredients();
    });

    async function editIngredient(id) {
      const response = await fetch(`/api/ingredients/${id}/`);
      const data = await response.json();

      document.querySelectorAll('#ingredient-list li').forEach(li => li.classList.remove('editing'));

      const items = document.querySelectorAll('#ingredient-list li');
      items.forEach(li => {
        if (li.innerHTML.includes(`editIngredient(${id})`)) {
          li.classList.add('editing');
        }
      });

      document.getElementById('ingredientID').value = id;
      document.getElementById('ingredient_name').value = data.ingredient_name;
      document.getElementById('type').value = data.type;
      document.getElementById('quantity_box').value = data.quantity_box;
      document.getElementById('current_box_stock').value = data.current_box_stock;
      document.getElementById('current_individual_stock').value = data.current_individual_stock;
      document.getElementById('expiration_date').value = data.expiration_date;
    }

    async function deleteIngredient(id) {
      if (!confirm('Are you sure you want to delete this ingredient?')) return;

      await fetch(`/api/ingredients/${id}/`, {
        method: 'DELETE'
      });

      fetchIngredients();
    }

    fetchIngredients();
  </script>

  <section>
    <h2>Miscellaneous</h2>

    <h3>Edit</h3>
    
    <form id="miscellaneous-form">
      <input type="hidden" id="miscellaneousID">
      <input type="text" id="miscellaneous_name" placeholder="Name" required>
      <input type="number" id="misc_quantity_box" placeholder="Quantity per Box" required>
      <input type="number" id="misc_current_box_stock" placeholder="Box Stock" required>
      <input type="number" id="misc_current_individual_stock" placeholder="Individual Stock" required>
      <button type="submit">Save Miscellaneous</button>
    </form>

    <ul id="miscellaneous-list"></ul>
  </section>

  <script>
    async function fetchMiscellaneous() {
      const response = await fetch('/api/miscellaneous/');
      const data = await response.json();
      const list = document.getElementById('miscellaneous-list');
      list.innerHTML = '';

      if (data.miscellaneous.length === 0) {
        list.innerHTML = '<li>No miscellaneous found.</li>';
        return;
      }

      data.miscellaneous.forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = `
          <div class="item-grid">
            <label>Name:</label> <span class="value">${item.miscellaneous_name}</span>
            <label>Boxes:</label> <span class="value">${item.current_box_stock}</span>
            <label>Individual:</label> <span class="value">${item.current_individual_stock}</span>
          </div>
          <span class="actions">
            <button onclick="editMiscellaneous(${item.miscellaneousID})">Edit</button>
            <button onclick="deleteMiscellaneous(${item.miscellaneousID})">Delete</button>
          </span>
        `;
        list.appendChild(li);
      });
    }

    document.getElementById('miscellaneous-form').addEventListener('submit', async function(e) {
      e.preventDefault();

      const id = document.getElementById('miscellaneousID').value;
      const payload = {
        miscellaneous_name: document.getElementById('miscellaneous_name').value,
        quantity_box: parseInt(document.getElementById('misc_quantity_box').value),
        current_box_stock: parseInt(document.getElementById('misc_current_box_stock').value),
        current_individual_stock: parseInt(document.getElementById('misc_current_individual_stock').value),
      };

      const url = id ? `/api/miscellaneous/${id}/` : `/api/miscellaneous/`;
      const method = id ? 'PUT' : 'POST';

      await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      this.reset();
      fetchMiscellaneous();
    });

    async function editMiscellaneous(id) {
      const response = await fetch(`/api/miscellaneous/${id}/`);
      const data = await response.json();

      document.querySelectorAll('#miscellaneous-list li').forEach(li => li.classList.remove('editing'));

      const items = document.querySelectorAll('#miscellaneous-list li');
      items.forEach(li => {
        if (li.innerHTML.includes(`editMiscellaneous(${id})`)) {
          li.classList.add('editing');
        }
      });

      document.getElementById('miscellaneousID').value = id;
      document.getElementById('miscellaneous_name').value = data.miscellaneous_name;
      document.getElementById('misc_quantity_box').value = data.quantity_box;
      document.getElementById('misc_current_box_stock').value = data.current_box_stock;
      document.getElementById('misc_current_individual_stock').value = data.current_individual_stock;
    }

    async function deleteMiscellaneous(id) {
      if (!confirm('Are you sure you want to delete this miscellaneous?')) return;

      await fetch(`/api/miscellaneous/${id}/`, {
        method: 'DELETE'
      });

      fetchMiscellaneous();
    }

    fetchMiscellaneous();
  </script>

</body>
</html>
